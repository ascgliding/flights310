{% extends 'base.html' %}

{% block header %}
<div style="display: table; width:100%" >
  <div style="display:table-row">
    <div style="display:table-cell">
      <h1>{% block title %}{{ pilot.fullname }}  Barometer {% endblock %}</h1>
    </div>
    <div style="display:table-cell; text-align: right;">
        <a class="action" href="{{ url_for('misc.currencydtl', id=pilot.id) }}" ,
           title="View Currency details">
            <button class="textbtn" id="detail" name="detail">Detail</button>
        </a>
    </div>
  </div>
  {% if msg  %}
  <div>
    {{ msg }}
  </div>
  {% endif %}
</div>
{% endblock %}

{% block content %}
  </div>
  {% if pilot.currency_barometer > 100 %}
    <div><br>No Barometer is shown - Pilot is "off the scale" ({{ pilot.currency_barometer }}%)</div>
  {% else %}
    <canvas id="barometer" style="padding-left: 15px;height:500px;object-fit:contain;"></canvas>
    <script>
      var c = document.getElementById("barometer");
      var heightRatio = 10.2;
      c.height = c.width * heightRatio;
      console.log(heightRatio);
      c.height = 400;
      c.width = 100;
      baroe = {{ pilot.currency_barometer }};
      var ctx = c.getContext("2d");
      ctx.moveTo(0, 0);
      // draw the boxes
      ctx.fillStyle = "green";
      ctx.fillRect(0,0,c.width/2-2,c.height/3);
      ctx.fillRect(c.width/2+2,0,c.width/2-2,c.height/3);
      ctx.fillStyle = "yellow";
      ctx.fillRect(0,c.height/3,c.width/2-2,c.height/3);
      ctx.fillRect(c.width/2+2,c.height/3,c.width/2-2,c.height/3);
      ctx.fillStyle = "red";
      ctx.fillRect(0,(c.height/3) * 2,c.width/2-2,c.height/3);
      ctx.fillRect(c.width/2+2,(c.height/3)*2,c.width/2-2,c.height/3);
      // draw the line from one side to another
      ctx.moveTo(0, c.height * {{ last12_hrs }});
      ctx.lineTo(c.width, c.height * {{ last12_launches }});
      ctx.stroke();
      ctx.fillStyle = "white";
      // fill the headings
      ctx.fillText("Hrs",10,8);
      ctx.fillText("Launches",c.width/2 + 4 ,8);

      // need to make sure it is not too near the top
      //ctx.fillStyle = "black";
      //if ( baroe > 90) {
      //  ctx.fillText(baroe,c.width/2, 20);
      //} else {
      //  ctx.fillText(baroe,c.width/2, c.height * (1 - (baroe / 100)));
      //}
      // Make a dot at the centre position
      pos = (c.height * (1 - (baroe / 100)));
      ctx.beginPath();
      ctx.arc(c.width/2,pos,5,0, 2 * Math.PI);
      ctx.fillStyle="blue";
      ctx.fill();
      ctx.stroke();

      // axes
      for (let i=5;i<40;i+=5) {
        pos = (c.height * (1-(i/41)));
        console.log(i , i/41);
        if ( i/41 > 0.66 ) {
          ctx.fillStyle="white";
        } else {
          ctx.fillStyle="black";
        };
        ctx.textAlign="right";
        ctx.fillText((i.toString()),c.width, pos);
        //drawArrow(ctx,70,arrowpos,30,arrowpos,5,'blue',i.toString());
        }
      for (let i=5;i<32;i+=5) {
        ctx.textAlign="left";
        pos = (c.height * (1-(i/32)));
        if ( i/32 > 0.66 ) {
          ctx.fillStyle="white";
        } else {
          ctx.fillStyle="black";
        };
        ctx.fillText((i.toString()),2, pos);
        //drawArrow(ctx,70,arrowpos,30,arrowpos,5,'blue',i.toString());
        }

      function drawArrow(ctx, fromx, fromy, tox, toy, arrowWidth, color, txt){
          //variables to be used when creating the arrow
          var headlen = 10;
          var angle = Math.atan2(toy-fromy,tox-fromx);

          ctx.save();
          ctx.strokeStyle = color;
          // add the text
          console.log(txt);
          ctx.fillText(txt,fromx,fromy);
          //starting path of the arrow from the start square to the end square
          //and drawing the stroke
          ctx.beginPath();
          ctx.moveTo(fromx, fromy);
          ctx.lineTo(tox, toy);
          ctx.lineWidth = arrowWidth;
          ctx.stroke();

          //starting a new path from the head of the arrow to one of the sides of
          //the point
          ctx.beginPath();
          ctx.moveTo(tox, toy);
          ctx.lineTo(tox-headlen*Math.cos(angle-Math.PI/7),
                     toy-headlen*Math.sin(angle-Math.PI/7));

          //path from the side point of the arrow, to the other side point
          ctx.lineTo(tox-headlen*Math.cos(angle+Math.PI/7),
                     toy-headlen*Math.sin(angle+Math.PI/7));

          //path from the side point back to the tip of the arrow, and then
          //again to the opposite side point
          ctx.lineTo(tox, toy);
          ctx.lineTo(tox-headlen*Math.cos(angle-Math.PI/7),
                     toy-headlen*Math.sin(angle-Math.PI/7));

          //draws the paths created above
          ctx.stroke();
          ctx.restore();
      }
    </script>
  {% endif %}

{% endblock %}